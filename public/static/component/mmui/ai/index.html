<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>åµŒå…¥å¼ AI èŠå¤©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <script src="https://unpkg.com/mdui@1.0.2/dist/js/mdui.min.js"></script>
    <!-- å¼•å…¥ mdui CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@1.0.2/dist/css/mdui.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <meta name="color-scheme" content="light">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJ+Y4Prk6kP1mKjxY4je3UbvNqX+OxuNAGAwc="
    crossorigin="anonymous"></script>

    <!-- å¼•å…¥ highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
   
   <style>

/* é€šç”¨ä»£ç å—æ ·å¼ */
/* é€šç”¨ä»£ç å—æ ·å¼ */
pre code.hljs {
    display: block !important;
    overflow-x: auto !important; /* å¯ç”¨æ¨ªå‘æ»šåŠ¨ */
    padding: 1.2em !important; /* å¢åŠ å†…è¾¹è· */
    border-radius: 8px !important; /* åœ†è§’è¾¹æ¡† */
    font-family: 'Fira Code', 'Consolas', 'Courier New', monospace !important; /* ä¸“ä¸šä»£ç å­—ä½“ */
    font-size: 1em !important; /* è°ƒæ•´å­—ä½“å¤§å° */
    line-height: 1.6 !important; /* æå‡è¡Œé—´è· */
    white-space: pre-wrap !important; /* ä¿ç•™æ¢è¡Œå¹¶æ”¯æŒè‡ªåŠ¨æ¢è¡Œ */
    word-wrap: break-word !important; /* é•¿å•è¯è‡ªåŠ¨æ¢è¡Œ */
}

/* è¡Œå†…ä»£ç å—æ ·å¼ */
.content code {
    padding: 4px 6px !important; /* å†…è¾¹è· */
    border-radius: 6px !important; /* åœ†è§’ */
    font-family: 'Fira Code', 'Consolas', 'Courier New', monospace !important; /* ä¸“ä¸šä»£ç å­—ä½“ */
    font-size: 0.95em !important; /* å­—ä½“ç¨å° */
    white-space: pre-wrap !important; /* ä¿ç•™æ¢è¡Œ */
    word-wrap: break-word !important; /* è‡ªåŠ¨æ¢è¡Œ */
}

/* é’ˆå¯¹ <code>, <kbd>, <samp> æ ‡ç­¾çš„æ ·å¼ */
code, kbd, samp {
    font-family: 'Fira Code', 'Consolas', 'Courier New', monospace !important; /* ç­‰å®½å­—ä½“ */
    font-size: 0.9em !important; /* ç›¸å¯¹è¾ƒå°çš„å­—ä½“ */
    padding: 3px 5px !important;
    border-radius: 5px !important;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
pre code.hljs::-webkit-scrollbar {
    height: 8px !important; /* çŸ®æ»šåŠ¨æ¡ */
}

pre code.hljs::-webkit-scrollbar-thumb {
    border-radius: 4px !important;
}

pre code.hljs::-webkit-scrollbar-track {
}

/* äº®è‰²ä¸»é¢˜ */
@media (prefers-color-scheme: light) {
    pre code.hljs {
        background: #eaf4fc !important; /* æµ…è“èƒŒæ™¯ */
        color: #1d3557 !important; /* æ·±è“æ–‡å­— */
        border: 1px solid #4dabf7 !important; /* è¾¹æ¡†ä¸ºè“è‰² */
    }

    .content code {
        background-color: #d7e9fc !important; /* æ›´æµ…çš„è“è‰² */
        color: #1a2e46 !important; /* æ·±è“è‰²æ–‡å­— */
        border: 1px solid #4dabf7 !important;
    }

    code, kbd, samp {
        background: #f0f8ff !important; /* æµ…è“èƒŒæ™¯ */
        color: #1a2e46 !important; /* æ·±è“æ–‡å­— */
        border: 1px solid #4dabf7 !important;
    }

    pre code.hljs::-webkit-scrollbar-thumb {
        background: #4dabf7 !important; /* è“è‰²æ»šåŠ¨æ¡ */
    }

    pre code.hljs::-webkit-scrollbar-track {
        background: #eaf4fc !important; /* æ»šåŠ¨æ¡è½¨é“é¢œè‰² */
    }
}

/* æš—è‰²ä¸»é¢˜ */
@media (prefers-color-scheme: dark) {
    pre code.hljs {
        background: #1e293b !important; /* æ·±è“ç°èƒŒæ™¯ */
        color: #ffffff !important; /* ç™½è‰²æ–‡å­— */
        border: 1px solid #4dabf7 !important; /* è“è‰²è¾¹æ¡† */
    }

    .content code {
        background-color: #243a57 !important; /* æ·±è“èƒŒæ™¯ */
        color: #ffffff !important; /* ç™½è‰²æ–‡å­— */
        border: 1px solid #4dabf7 !important;
    }

    code, kbd, samp {
        background: #2c3e58 !important; /* æ·±è“èƒŒæ™¯ */
        color: #ffffff !important; /* ç™½è‰²æ–‡å­— */
        border: 1px solid #4dabf7 !important;
    }

    pre code.hljs::-webkit-scrollbar-thumb {
        background: #4dabf7 !important; /* è“è‰²æ»šåŠ¨æ¡ */
    }

    pre code.hljs::-webkit-scrollbar-track {
        background: #1e293b !important; /* æ»šåŠ¨æ¡è½¨é“é¢œè‰² */
    }
}


        /* åŸºç¡€æ ·å¼ */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* é™åˆ¶æº¢å‡º */
            font-family: 'Helvetica Neue', Arial, 'San Francisco', sans-serif; /* ä¸»å­—ä½“ */
            line-height: 1.6; /* æå‡å¯è¯»æ€§ */
            color: #333; /* æ·±ç°è‰²æ–‡å­— */
            background-color: #f4f5f7; /* æŸ”å’Œçš„æµ…ç°èƒŒæ™¯ */
            transition: background-color 0.3s, color 0.3s; /* å¹³æ»‘è¿‡æ¸¡ */
        }
    
        /* å“åº”å¼å¸ƒå±€ */
        .chat-container {
            display: flex;
            height: calc(100% - 64px); /* å‡å»å·¥å…·æ é«˜åº¦ */
        }
    
        @media (max-width: 768px) {
            .chat-container {
                padding-top: 0; /* ç§»åŠ¨ç«¯ç§»é™¤é¡¶éƒ¨å†…è¾¹è· */
                height: calc(100% - var(--toolbar-height)); /* ä½¿ç”¨åŠ¨æ€å˜é‡ */
            }
        }
    
        /* ä¾§è¾¹æ æ ·å¼ */
        .chat-sidebar {
            width: 240px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            background-color: #ffffff;
            transition: background-color 0.3s, color 0.3s;
        }
    
        /* ä¸»èŠå¤©åŒºæ ·å¼ */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
    
        /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background-color: #f9f9f9; /* æ¶ˆæ¯åŒºåŸŸèƒŒæ™¯è‰² */
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
    
        /* è¾“å…¥æ¡†åŒºåŸŸ */
        .chat-input {
            padding: 16px;
            border-top: 1px solid #dcdcdc; /* åˆ†éš”çº¿ */
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #ffffff; /* ç™½è‰²èƒŒæ™¯ */
            transition: background-color 0.3s, border-color 0.3s;
        }
    
        .chat-input textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: none;
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
    
        .chat-input textarea:focus {
            border-color: #4dabf7; /* èšç„¦æ—¶çš„è¾¹æ¡†é¢œè‰² */
            outline: none;
            background-color: #f0f8ff; /* èšç„¦æ—¶èƒŒæ™¯é¢œè‰² */
        }
    
        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            margin-bottom: 12px;
            position: relative;
            display: flex;
            align-items: flex-start;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.3s forwards; /* æ¶ˆæ¯æ·¡å…¥åŠ¨ç”» */
        }
    
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    
        /* ç”¨æˆ·æ¶ˆæ¯å¯¹é½ */
        .message.user {
            flex-direction: row-reverse;
        }
    
        /* åŠ©æ‰‹æ¶ˆæ¯å¯¹é½ */
        .message.assistant,
        .message.function {
            flex-direction: row;
        }
    
        /* ç”¨æˆ·æ¶ˆæ¯èƒŒæ™¯å’Œæ–‡å­—é¢œè‰² */
        .message.user .content {
            background-color: #4dabf7; /* ä¸»é¢˜è“è‰²èƒŒæ™¯ */
            color: #ffffff; /* ç™½è‰²æ–‡å­— */
            align-self: flex-end;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            border-bottom-left-radius: 15px;
            transition: background-color 0.3s, color 0.3s;
        }
    
        /* åŠ©æ‰‹æ¶ˆæ¯èƒŒæ™¯å’Œæ–‡å­—é¢œè‰² */
        .message.assistant .content {
            background-color: #e3f2fd; /* æµ…è“è‰²èƒŒæ™¯ */
            color: #1a1a1a; /* æ·±ç°è‰²æ–‡å­— */
            align-self: flex-start;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            border-bottom-right-radius: 15px;
            transition: background-color 0.3s, color 0.3s;
        }
    
        /* å‡½æ•°æ¶ˆæ¯èƒŒæ™¯å’Œæ–‡å­—é¢œè‰² */
        .message.function .content {
            background-color: #c3eafe; /* æ›´æµ…çš„è“è‰²èƒŒæ™¯ */
            color: #1a1a1a; /* æ·±ç°è‰²æ–‡å­— */
            align-self: flex-start;
            border-radius: 15px;
            transition: background-color 0.3s, color 0.3s;
        }
    
        /* å¤´åƒæ ·å¼ */
        .avatar {
            width: 40px;
            aspect-ratio: 1;
            object-fit: cover;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            background-color: #e3f2fd; /* ä¸åŠ©æ‰‹èƒŒæ™¯ä¸€è‡´ */
            color: #1a1a1a;
            transition: background-color 0.3s, color 0.3s;
        }
    
        /* æ¶ˆæ¯å†…å®¹æ ·å¼ */
        .content {
            position: relative;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 70%;
            word-wrap: break-word;
            transition: background-color 0.3s, color 0.3s;
            font-size: 15px;
            font-family: 'Helvetica Neue', Arial, 'San Francisco', sans-serif;
            color: #333;
            letter-spacing: 0.2px;
        }
    
        .message:hover .content {
            background-color: #d0e7ff; /* æ·¡è“è‰² */
        }
    
        /* ä»£ç å—æ ·å¼ */
        .code-block {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px;
            font-family: Consolas, monospace;
            font-size: 14px;
            position: relative;
            overflow-x: auto;
            margin: 20px 0;
            transition: background-color 0.3s, border-color 0.3s;
        }
    
        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    
        .code-block .language-label {
            top: -10px;
            right: 15px;
            background-color: #4dabf7; /* ä¸»é¢˜è“è‰² */
            color: white;
            padding: 2px 8px;
            font-size: 12px;
            font-family: Arial, sans-serif;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
    
        /* å¤åˆ¶æŒ‰é’®æ ·å¼ */
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background-color: #4dabf7; /* ä¸»é¢˜è“è‰² */
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            transition: background-color 0.3s;
        }
    
        .copy-btn:hover {
            background-color: #357ab8; /* æ·±è“è‰² */
        }
    
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes scroll-light {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
    
        /* "æ­£åœ¨æ€è€ƒ..." æ–‡æœ¬çš„æ ·å¼ */
        .loading-message .content {
            background-color: #e3f2fd; /* æµ…è“è‰²èƒŒæ™¯ */
            color: #6c757d; /* ç°è‰²æ–‡å­— */
            font-style: italic;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
    
        .loading-message .content::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.4) 50%, rgba(255, 255, 255, 0) 100%);
            animation: scroll-light 1.5s infinite;
        }
    
        /* é—ªçƒå…‰æ ‡æ ·å¼ */
        .blinking-cursor {
            display: inline;
            color: #6c757d;
            font-weight: bold;
            animation: blink 1s step-start infinite;
        }
    
        @keyframes blink {
            50% {
                opacity: 0;
            }
        }
    
        /* æŒ‰é’®æ ·å¼ */
        .message-buttons {
            margin-top: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            height: 24px;
        }
    
        .message:hover .message-buttons {
            opacity: 1;
        }
    
        .delete-btn,
        .edit-btn,
        .copy-btn,
        .regenerate-btn {
            background: none;
            border: none;
            color: #4dabf7; /* ä¸»é¢˜è“è‰² */
            cursor: pointer;
            font-size: 18px;
            transition: color 0.3s;
        }
    
        .delete-btn:hover,
        .edit-btn:hover,
        .copy-btn:hover,
        .regenerate-btn:hover {
            color: #357ab8; /* æ·±è“è‰² */
        }
    
        /* Markdown ç®€å•æ ·å¼ */
        .content h1 {
            font-size: 1.5em;
            color: #4dabf7;
        }
    
        .content h2 {
            font-size: 1.3em;
            color: #4dabf7;
        }
    
        .content h3 {
            font-size: 1.1em;
            color: #4dabf7;
        }
    
        .content strong {
            font-weight: bold;
        }
    
        .content em {
            font-style: italic;
        }
    
        .content code {
            background-color: #eee;
            padding: 2px 4px;
            border-radius: 4px;
        }
    
        .content pre {

            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }
    
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    
        /* èŠå¤©åˆ—è¡¨æ ·å¼ */
        .chat-list-header {
            padding: 16px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #fff;
            transition: background-color 0.3s, color 0.3s;
        }
    
        .chat-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.3s, color 0.3s;
        }
    
        .chat-item.active {
            background-color: #c3eafe; /* æ·¡è“è‰² */
        }
    
        .chat-item:hover {
            background-color: #e0f7fa; /* æ›´æµ…çš„è“è‰² */
        }
    
        .chat-item .chat-title {
            flex: 1;
        }
    
        .chat-item .delete-chat-btn {
            background: none;
            border: none;
            color: #4dabf7; /* ä¸»é¢˜è“è‰² */
            cursor: pointer;
            margin-left: 8px;
            transition: color 0.3s;
        }
    
        .chat-item .delete-chat-btn:hover {
            color: #357ab8; /* æ·±è“è‰² */
        }
    
        /* ä»£ç å—å¤åˆ¶æŒ‰é’®æ ·å¼ */
        .code-copy-btn,
        .code-preview-btn {
            display: none;
        }
    
        pre:hover .code-copy-btn,
        pre:hover .code-preview-btn {
            display: block;
        }
    
        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: absolute;
            z-index: 1000;
            background-color: #ffffff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: none;
            min-width: 120px;
            transition: background-color 0.3s, color 0.3s;
        }
    
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.3s, color 0.3s;
        }
    
        .context-menu-item:hover {
            background-color: #e0f7fa; /* æ›´æµ…çš„è“è‰² */
        }
    
        /* è¿”å›åº•éƒ¨æŒ‰é’®æ ·å¼ */
        #scrollToBottomBtn {
            position: fixed;
            bottom: 80px;
            right: 30px;
            display: none;
            z-index: 999;
            background-color: #4dabf7; /* ä¸»é¢˜è“è‰² */
            color: #ffffff;
            border: none;
            padding: 10px 15px;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    
        #scrollToBottomBtn:hover {
            background-color: #357ab8; /* æ·±è“è‰² */
            transform: translateY(-2px);
        }
    
        /* æ¨¡å‹é€‰æ‹©å™¨æ ·å¼ */
        #modelSelector {
            width: 150px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #4dabf7;
            background-color: #ffffff;
            color: #333;
            transition: border-color 0.3s;
        }
    
        #modelSelector:hover,
        #modelSelector:focus {
            border-color: #357ab8;
            outline: none;
        }
    
        /* å‡½æ•°è°ƒç”¨æç¤ºæ¡†æ ·å¼ */
        #functionCallTip {
            position: fixed;
            top: 80px;
            right: 30px;
            background-color: #ffffff;
            border: 1px solid #4dabf7;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            border-radius: 5px;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
    
        /* åŠ¨ç”»å’Œè¿‡æ¸¡ä¼˜åŒ– */
        .gridA {
            display: flex;
            align-content: space-around;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
            transition: all 0.3s ease-in-out;
        }
    
        /* è·‘é©¬ç¯åŠ¨ç”»æ¡ */
        .loading-message .content::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.4) 50%, rgba(255, 255, 255, 0) 100%);
            animation: scroll-light 1.5s infinite;
        }
    
        /* é—ªçƒåŠ¨ç”» */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    
        /* è¿”å›åº•éƒ¨æŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘ */
        #scrollToBottomBtn.show {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
    
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    
        /* ä¸»é¢˜åˆ‡æ¢ï¼ˆæ·±è‰²æ¨¡å¼ï¼‰ */
        @media (prefers-color-scheme: dark) {
            body {
                color: #eaeaea; /* æµ…ç°è‰²æ–‡å­— */
                background-color: #121212; /* æ·±è‰²èƒŒæ™¯ */
            }
    
            .chat-sidebar,
            .chat-main,
            .chat-messages,
            .chat-input,
            .chat-list-header,
            .chat-item,
            .context-menu,
            #functionCallTip,
            .code-block,
            .copy-btn,
            #scrollToBottomBtn,
            #modelSelector {
                transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            }
    
            #functionCallTip {
                color: #eaeaea;
                background-color: #1e1e1e;
                border: 1px solid #4dabf7;
                box-shadow: 0 2px 5px rgba(32, 34, 61, 0.349);
                display: none;
                z-index: 1000;
            }
    
            /* å·¥å…·æ  */
            .mdui-appbar {
                background-color: #1e1e1e !important; /* æ·±è‰²å·¥å…·æ èƒŒæ™¯ */
                color: #eaeaea;
                transition: background-color 0.3s, color 0.3s;
            }
    
            /* èŠå¤©æ¶ˆæ¯èƒŒæ™¯ */
            .chat-messages {
                background-color: #1e1e1e; /* æ·±ç°èƒŒæ™¯ */
                color: #eaeaea; /* æµ…ç°è‰²æ–‡å­— */
            }
    
            /* è¾“å…¥æ¡† */
            .chat-input {
                background-color: #1e1e1e; /* æ·±ç°èƒŒæ™¯ */
                border-top: 1px solid #333;
                color: #eaeaea; /* æµ…ç°è‰²æ–‡å­— */
            }
    
            .chat-input textarea {
                background-color: #2a2a2a; /* æ›´æ·±çš„è¾“å…¥æ¡†èƒŒæ™¯ */
                color: #eaeaea;
            }
    
            .chat-input textarea:focus {
                border-color: #4dabf7; /* èšç„¦æ—¶çš„è¾¹æ¡†é¢œè‰² */
            }
    
            /* ç”¨æˆ·æ¶ˆæ¯ */
            .message.user .content {
                background-color: #4dabf7; /* ä¸»é¢˜è“è‰²èƒŒæ™¯ */
                color: #ffffff; /* ç™½è‰²æ–‡å­— */
            }
    
            /* åŠ©æ‰‹æ¶ˆæ¯ */
            .message.assistant .content {
                background-color: #3d3d3d; /* æ·±ç°èƒŒæ™¯ */
                color: #eaeaea; /* æµ…ç°æ–‡å­— */
            }
    
            /* å‡½æ•°æ¶ˆæ¯ */
            .message.function .content {
                background-color: #4b3f27; /* æ£•è‰²èƒŒæ™¯ */
                color: #ffffff; /* ç™½è‰²æ–‡å­— */
            }
    
            /* æŒ‰é’®æ ·å¼ */
            .mdui-btn {
                background-color: #1e1e1e; /* æ·±ç°èƒŒæ™¯ */
                color: #eaeaea;
                transition: background-color 0.3s, color 0.3s;
            }
    
            .mdui-btn:hover {
                background-color: #3d3d3d;
            }
    
            /* èŠå¤©åˆ—è¡¨ */
            .chat-list-header {
                background-color: #1e1e1e;
                color: #eaeaea;
            }
    
            .chat-item {
                background-color: #1e1e1e;
                color: #eaeaea;
            }
    
            .chat-item:hover {
                background-color: #333;
            }
    
            .chat-item.active {
                background-color: #4dabf7; /* ä¸»é¢˜è“è‰² */
                color: #fff;
            }
    
            /* å³é”®èœå• */
            .context-menu {
                background-color: #1e1e1e;
                color: #eaeaea;
                border: 1px solid #333;
            }
    
            .context-menu-item:hover {
                background-color: #333;
            }
    
            /* ä»£ç å— */
            pre code {
                background-color: #2a2a2a;
                color: #eaeaea;
            }
    
            .code-block .language-label {
                background-color: #4dabf7;
            }
    
            .copy-btn {
                background-color: #2a2a2a;
                color: #eaeaea;
            }
    
            .copy-btn:hover {
                background-color: #3d3d3d;
            }
    
            /* è¿”å›åº•éƒ¨æŒ‰é’® */
            #scrollToBottomBtn {
                background-color: #4dabf7;
                color: #ffffff;
            }
    
            #scrollToBottomBtn:hover {
                background-color: #357ab8;
            }
        }
    
        /* ç°ä»£èˆ’é€‚çš„åŠ¨æ•ˆä¼˜åŒ– */
        /* å¹³æ»‘è¿‡æ¸¡ */
        * {
            transition: all 0.3s ease-in-out;
        }
    
        /* æŒ‰é’®è½»å¾®æ”¾å¤§æ•ˆæœ */
        button, .copy-btn, .delete-btn, .edit-btn, .regenerate-btn {
            transition: transform 0.2s ease-in-out, background-color 0.3s;
        }
    
        button:hover, .copy-btn:hover, .delete-btn:hover, .edit-btn:hover, .regenerate-btn:hover {
            transform: scale(1.05);
        }
    
        /* ä¾§è¾¹æ æ»šåŠ¨æ¡æ ·å¼ */
        .chat-sidebar::-webkit-scrollbar {
            width: 8px;
        }
    
        .chat-sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
    
        .chat-sidebar::-webkit-scrollbar-thumb {
            background: #4dabf7;
            border-radius: 4px;
        }
    
        .chat-sidebar::-webkit-scrollbar-thumb:hover {
            background: #357ab8;
        }
    
        /* èŠå¤©æ¶ˆæ¯åŒºæ»šåŠ¨æ¡æ ·å¼ */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
    
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
    
        .chat-messages::-webkit-scrollbar-thumb {
            background: #4dabf7;
            border-radius: 4px;
        }
    
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #357ab8;
        }
    </style>
    
</head>

<body
    class="mdui-drawer-body-left mdui-appbar-with-toolbar mdui-theme-auto mdui-theme-blue mdui-loaded  dark-mode ">
    <!-- å·¥å…·æ  -->
    <div class="mdui-appbar appbar mdui-appbar-fixed mdui-color-light-blue-a700">

        <div class="mdui-toolbar ">
            <button class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#drawer'}">
                <i class="mdui-icon material-icons">menu</i>
            </button>
            <span class="mdui-typo-title">AI èŠå¤©</span>
            <!-- æ¨¡å‹é€‰æ‹©å™¨ -->
            <select id="modelSelector" class="mdui-select">
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                <option value="gpt-3.5-turbo-0613">GPT-3.5 Turbo-0613</option>
                <option value="gpt-4">GPT-4</option>
            </select>
            <div class="mdui-toolbar-spacer"></div>
            <button class="mdui-btn mdui-btn-icon" id="configBtn"><i
                    class="mdui-icon material-icons">settings</i></button>
        </div>


    </div>

    <div class="mdui-drawer "  id="drawer">
        <div class="chat-list">
            <div class="chat-list-header">
                <span>èŠå¤©ä¼šè¯</span>
                <button class="mdui-btn mdui-btn-icon" id="addChatBtn"><i
                        class="mdui-icon material-icons">add</i></button>
            </div>
            <div id="chatList">
                <!-- èŠå¤©åˆ—è¡¨å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
    </div>
    <div class="chat-container ">


        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <!-- èŠå¤©æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
            <!-- è¿”å›åº•éƒ¨æŒ‰é’® -->
            <button class="mdui-fab mdui-fab-mini mdui-color-theme-accent" id="scrollToBottomBtn">
                <i class="mdui-icon material-icons ">arrow_downward</i>
            </button>
            <!-- å‡½æ•°è°ƒç”¨æç¤ºæ¡† -->
            <div id="functionCallTip"></div>
            <div class="chat-input">
                <textarea id="userInput" class="mdui-textfield-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯"
                    style="flex: 1; resize: none;"></textarea>
                <button class="mdui-btn mdui-btn-icon" id="sendBtn"><i
                        class="mdui-icon material-icons">send</i></button>
                <button class="mdui-btn mdui-btn-icon" id="voiceBtn"><i
                        class="mdui-icon material-icons">mic</i></button>
                <button class="mdui-btn mdui-btn-icon" id="fileUploadBtn"><i
                        class="mdui-icon material-icons">attach_file</i></button>
                <input type="file" id="fileInput" style="display: none;" multiple />

            </div>
        </div>
    </div>

    <!-- é…ç½®å¯¹è¯æ¡† -->
    <div class="mdui-dialog" id="configDialog">
        <div class="mdui-dialog-title">é…ç½®</div>
        <div class="mdui-dialog-content">
            <div class="mdui-textfield mdui-textfield-floating-label">
                <label class="mdui-textfield-label">API Base URL</label>
                <input class="mdui-textfield-input" type="text" id="apiBaseUrl"
                    value="https://181db8c2fb36d34200f8ce83762f64a2.api-forwards.com/v1/chat/completions" />
            </div>
            <div class="mdui-textfield mdui-textfield-floating-label">
                <label class="mdui-textfield-label">API Key</label>
                <input class="mdui-textfield-input" type="password" id="apiKey" />
            </div>
        </div>
        <div class="mdui-dialog-actions">
            <button class="mdui-btn mdui-btn-icon" id="exportBtn"><i
                class="mdui-icon material-icons">file_download</i></button>
        <button class="mdui-btn mdui-btn-icon" id="importBtn"><i
                class="mdui-icon material-icons">file_upload</i></button>
            <button class="mdui-btn mdui-ripple" mdui-dialog-close>å–æ¶ˆ</button>
            <button class="mdui-btn mdui-ripple" id="saveConfig">ä¿å­˜</button>
        </div>
    </div>

    <!-- å¯¼å…¥æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="importFile" accept=".json" style="display: none;" />

    <!-- å³é”®èœå• -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" id="copyMessage">å¤åˆ¶æ¶ˆæ¯</div>
    </div>

    <!-- å¼•å…¥ mdui JS -->
    <script src="https://cdn.jsdelivr.net/npm/mdui@1.0.2/dist/js/mdui.min.js"></script>
    <!-- å¼•å…¥ highlight.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <!-- å¼•å…¥ highlight.js è¯­è¨€åŒ… -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
    <script>
        // åˆå§‹åŒ–å˜é‡
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const fileUploadBtn = document.getElementById('fileUploadBtn');
        const fileInput = document.getElementById('fileInput');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const addChatBtn = document.getElementById('addChatBtn');
        const importFile = document.getElementById('importFile');
        const chatList = document.getElementById('chatList');
        const contextMenu = document.getElementById('contextMenu');
        const copyMessageItem = document.getElementById('copyMessage');
        const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
        const modelSelector = document.getElementById('modelSelector');
        const functionCallTip = document.getElementById('functionCallTip');

        let clickedMessageContent = ''; // å­˜å‚¨è¢«å³é”®ç‚¹å‡»çš„æ¶ˆæ¯å†…å®¹

        // é…ç½®å˜é‡
        let apiBaseUrl = localStorage.getItem('apiBaseUrl') || 'https://api.openai.com/v1/chat/completions';
        let apiKey = localStorage.getItem('apiKey') || '';
        let selectedModel = localStorage.getItem('selectedModel') || 'gpt-3.5-turbo';

        // èŠå¤©ä¼šè¯åˆ—è¡¨
        let chats = JSON.parse(localStorage.getItem('chats')) || [];
        let currentChatId = localStorage.getItem('currentChatId') || null;

        // èŠå¤©è®°å½•ç®¡ç†
        function getChatById(id) {
            return chats.find(chat => chat.id === id);
        }

        function saveChats() {
            localStorage.setItem('chats', JSON.stringify(chats));
            localStorage.setItem('currentChatId', currentChatId);
        }

        // æ¸²æŸ“èŠå¤©åˆ—è¡¨
        function renderChatList() {
            chatList.innerHTML = '';
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.classList.add('chat-item');
                if (chat.id === currentChatId) {
                    chatItem.classList.add('active');
                }

                const chatTitle = document.createElement('div');
                chatTitle.classList.add('chat-title');
                chatTitle.textContent = chat.name;

                const deleteChatBtn = document.createElement('button');
                deleteChatBtn.classList.add('delete-chat-btn');
                deleteChatBtn.innerHTML = '<i class="mdui-icon material-icons">delete</i>';
                deleteChatBtn.title = 'åˆ é™¤èŠå¤©';
                deleteChatBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteChat(chat.id);
                });

                chatItem.appendChild(chatTitle);
                chatItem.appendChild(deleteChatBtn);
                chatItem.addEventListener('click', () => {
                    switchChat(chat.id);
                });

                chatList.appendChild(chatItem);
            });
        }

        // åˆ‡æ¢èŠå¤©ä¼šè¯
        function switchChat(id) {
            currentChatId = id;
            saveChats();
            renderChatList();
            renderChat();
        }

        // æ·»åŠ æ–°çš„èŠå¤©ä¼šè¯
        function addNewChat(name = 'æ–°èŠå¤©') {
            const newChat = {
                id: Date.now().toString(),
                name: name,
                messages: []
            };
            chats.push(newChat);
            currentChatId = newChat.id;
            saveChats();
            renderChatList();
            renderChat();
        }

        // åˆ é™¤èŠå¤©ä¼šè¯
        function deleteChat(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤èŠå¤©ä¼šè¯å—ï¼Ÿ')) return;
            chats = chats.filter(chat => chat.id !== id);
            if (currentChatId === id) {
                currentChatId = chats.length > 0 ? chats[chats.length - 1].id : null;
            }
            saveChats();
            renderChatList();
            renderChat();
        }

        // æ¸²æŸ“å½“å‰èŠå¤©
        function renderChat() {
            chatMessages.innerHTML = '';
            const currentChat = getChatById(currentChatId);
            if (!currentChat) {
                chatMessages.innerHTML = '<div class="mdui-typo">è¯·é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªèŠå¤©ä¼šè¯</div>';
                return;
            }

            // ç¡®ä¿æ¯æ¡æ¶ˆæ¯éƒ½æœ‰å”¯ä¸€çš„ id
            currentChat.messages.forEach(msg => {
                if (!msg.id) {
                    msg.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                }
                appendMessage(msg);
            });
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©è®°å½•å¹¶æ›´æ–°ç•Œé¢
        function addMessage(message) {
            const currentChat = getChatById(currentChatId);
            if (currentChat) {
                message.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                currentChat.messages.push(message);
                saveChats();
                appendMessage(message);
                // è‡ªåŠ¨ç”ŸæˆèŠå¤©æ ‡é¢˜
                if (message.role === 'user') {
                    generateChatTitle();
                }
            }
        }

        // è¿½åŠ å•æ¡æ¶ˆæ¯åˆ°ç•Œé¢
        function appendMessage(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', msg.role);
            messageDiv.id = `message-${msg.id}`;

            // æ·»åŠ å¤´åƒï¼ˆä½¿ç”¨Emojiï¼‰
            const avatarSpan = document.createElement('span');
            avatarSpan.classList.add('avatar');
            if (msg.role === 'user') {
                avatarSpan.textContent = 'ğŸ‘¤'; // ç”¨æˆ·å¤´åƒEmoji
            } else if (msg.role === 'assistant') {
                avatarSpan.textContent = 'ğŸ¤–'; // åŠ©æ‰‹å¤´åƒEmoji
            } else if (msg.role === 'function') {
                avatarSpan.textContent = 'ğŸ”§'; // å‡½æ•°å¤´åƒEmoji
            } else {
                avatarSpan.textContent = 'â“'; // é»˜è®¤å¤´åƒEmoji
            }

            // åˆ›å»ºå†…å®¹å®¹å™¨
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('content');
            contentDiv.innerHTML = parseMarkdown(msg.content);

            // å¦‚æœæ˜¯åŠ è½½ä¸­çš„æ¶ˆæ¯ï¼Œæ·»åŠ ç‰¹æ®Šçš„ç±»
            if (msg.loading) {
                messageDiv.classList.add('loading-message');
                contentDiv.innerHTML = 'æ­£åœ¨æ€è€ƒ...';
            }

            // å³é”®èœå•äº‹ä»¶
            contentDiv.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                clickedMessageContent = msg.content;
                showContextMenu(e.pageX, e.pageY);
            });

            // åˆ›å»ºæŒ‰é’®å®¹å™¨
            const buttonsDiv = document.createElement('div');
            buttonsDiv.classList.add('message-buttons');

            // æ·»åŠ åˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-btn');
            deleteBtn.innerHTML = '<i class="mdui-icon material-icons">delete</i>';
            deleteBtn.title = 'åˆ é™¤æ¶ˆæ¯';
            deleteBtn.addEventListener('click', () => {
                deleteMessage(msg.id);
            });
            buttonsDiv.appendChild(deleteBtn);

            // æ·»åŠ ç¼–è¾‘æŒ‰é’®
            const editBtn = document.createElement('button');
            editBtn.classList.add('edit-btn');
            editBtn.innerHTML = '<i class="mdui-icon material-icons">edit</i>';
            editBtn.title = 'ç¼–è¾‘æ¶ˆæ¯';
            editBtn.addEventListener('click', () => {
                editMessage(msg.id);
            });
            buttonsDiv.appendChild(editBtn);

            // æ·»åŠ å¤åˆ¶æŒ‰é’®


            // æ·»åŠ é‡æ–°ç”ŸæˆæŒ‰é’®ï¼ˆä»…å¯¹åŠ©æ‰‹æ¶ˆæ¯ï¼‰
            if (msg.role === 'assistant' && !msg.loading) {
                const regenerateBtn = document.createElement('button');
                regenerateBtn.classList.add('regenerate-btn');
                regenerateBtn.innerHTML = '<i class="mdui-icon material-icons">autorenew</i>';
                regenerateBtn.title = 'é‡æ–°ç”Ÿæˆå›å¤';
                regenerateBtn.addEventListener('click', () => {
                    regenerateMessage(msg.id);
                });
                buttonsDiv.appendChild(regenerateBtn);
            }

            // å°†æŒ‰é’®å®¹å™¨æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨
            const messageContentWrapper = document.createElement('div');
            messageContentWrapper.classList.add('gridA');
            messageContentWrapper.appendChild(contentDiv);
            messageContentWrapper.appendChild(buttonsDiv);

            // å°†å¤´åƒå’Œå†…å®¹æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨
            if (msg.role === 'user') {
                messageDiv.appendChild(avatarSpan);
                messageDiv.appendChild(messageContentWrapper);
            } else {
                messageDiv.appendChild(avatarSpan);
                messageDiv.appendChild(messageContentWrapper);
            }

            // å¯¹ä»£ç å—è¿›è¡Œè¯­æ³•é«˜äº®å’Œæ·»åŠ æŒ‰é’®
            if (!msg.loading) {
                contentDiv.querySelectorAll('pre').forEach((pre) => {
                    const code = pre.querySelector('code');
                    const codeContent = code.innerText;
                    const language = code.className || ''; // è·å–è¯­è¨€

                    // è¯­æ³•é«˜äº®
                    hljs.highlightElement(code);

                    // åˆ›å»ºå¤åˆ¶æŒ‰é’®
                    const copyButton = document.createElement('button');
                    copyButton.classList.add('code-copy-btn');
                    copyButton.innerHTML = '<i class="mdui-icon material-icons">content_copy</i>';
                    copyButton.title = 'å¤åˆ¶ä»£ç ';
                    copyButton.addEventListener('click', () => {
                        navigator.clipboard.writeText(codeContent).then(() => {
                            mdui.snackbar({ message: 'ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿' });
                        }).catch(err => {
                            mdui.snackbar({ message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶' });
                        });
                    });
                    copyButton.style.position = 'absolute';
                    copyButton.style.top = '5px';
                    copyButton.style.right = '5px';
                    copyButton.style.background = 'none';
                    copyButton.style.border = 'none';
                    copyButton.style.color = '#999';
                    copyButton.style.cursor = 'pointer';

                    pre.appendChild(copyButton);

                    // æ£€æŸ¥æ˜¯å¦æ˜¯ HTML ä»£ç ï¼Œæ·»åŠ é¢„è§ˆæŒ‰é’®
                    if (isHtmlCode(codeContent)) {
                        const previewButton = document.createElement('button');
                        previewButton.classList.add('code-preview-btn');
                        previewButton.innerHTML = '<i class="mdui-icon material-icons">visibility</i>';
                        previewButton.title = 'é¢„è§ˆ HTML';
                        previewButton.addEventListener('click', () => {
                            showHtmlPreview(codeContent);
                        });
                        previewButton.style.position = 'absolute';
                        previewButton.style.top = '5px';
                        previewButton.style.right = '35px';
                        previewButton.style.background = 'none';
                        previewButton.style.border = 'none';
                        previewButton.style.color = '#999';
                        previewButton.style.cursor = 'pointer';

                        pre.appendChild(previewButton);
                    }
                });
            }

            chatMessages.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ›´æ–°æ¶ˆæ¯å…ƒç´ 
        function updateMessageElement(msg) {
            const messageDiv = document.getElementById(`message-${msg.id}`);
            if (messageDiv) {
                const contentDiv = messageDiv.querySelector('.content');
                let contentHTML = parseMarkdown(msg.content);

                if (msg.loading) {
                    // åœ¨æ¶ˆæ¯æœ«å°¾æ·»åŠ é—ªçƒå…‰æ ‡
                    contentHTML += '<span class="blinking-cursor">_</span>';
                }

                contentDiv.innerHTML = contentHTML;
                messageDiv.classList.remove('loading-message');

                // é‡æ–°ç»‘å®šäº‹ä»¶å’Œè¯­æ³•é«˜äº®
                contentDiv.querySelectorAll('pre').forEach((pre) => {
                    const code = pre.querySelector('code');
                    const codeContent = code.innerText;
                    const language = code.className || '';

                    // è¯­æ³•é«˜äº®
                    hljs.highlightElement(code);

                    // åˆ›å»ºå¤åˆ¶æŒ‰é’®
                    const copyButton = document.createElement('button');
                    copyButton.classList.add('code-copy-btn');
                    copyButton.innerHTML = '<i class="mdui-icon material-icons">content_copy</i>';
                    copyButton.title = 'å¤åˆ¶ä»£ç ';
                    copyButton.addEventListener('click', () => {
                        navigator.clipboard.writeText(codeContent).then(() => {
                            mdui.snackbar({ message: 'ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿' });
                        }).catch(err => {
                            mdui.snackbar({ message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶' });
                        });
                    });
                    copyButton.style.position = 'absolute';
                    copyButton.style.top = '5px';
                    copyButton.style.right = '5px';
                    copyButton.style.background = 'none';
                    copyButton.style.border = 'none';
                    copyButton.style.color = '#999';
                    copyButton.style.cursor = 'pointer';

                    pre.appendChild(copyButton);

                    // æ£€æŸ¥æ˜¯å¦æ˜¯ HTML ä»£ç ï¼Œæ·»åŠ é¢„è§ˆæŒ‰é’®
                    if (isHtmlCode(codeContent)) {
                        const previewButton = document.createElement('button');
                        previewButton.classList.add('code-preview-btn');
                        previewButton.innerHTML = '<i class="mdui-icon material-icons">visibility</i>';
                        previewButton.title = 'é¢„è§ˆ HTML';
                        previewButton.addEventListener('click', () => {
                            showHtmlPreview(codeContent);
                        });
                        previewButton.style.position = 'absolute';
                        previewButton.style.top = '5px';
                        previewButton.style.right = '35px';
                        previewButton.style.background = 'none';
                        previewButton.style.border = 'none';
                        previewButton.style.color = '#999';
                        previewButton.style.cursor = 'pointer';

                        pre.appendChild(previewButton);
                    }
                });
            }
        }

        // åˆ é™¤æ¶ˆæ¯
        function deleteMessage(msgId) {
            const currentChat = getChatById(currentChatId);
            if (currentChat) {
                const index = currentChat.messages.findIndex(msg => msg.id === msgId);
                if (index !== -1) {
                    currentChat.messages.splice(index, 1);
                    saveChats();

                    // ç§»é™¤æ¶ˆæ¯å…ƒç´ 
                    const messageDiv = document.getElementById(`message-${msgId}`);
                    if (messageDiv) {
                        messageDiv.remove();
                    }
                }
            }
        }

        // ç¼–è¾‘æ¶ˆæ¯
        function editMessage(msgId) {
            const currentChat = getChatById(currentChatId);
            if (currentChat) {
                const msg = currentChat.messages.find(m => m.id === msgId);

                // ä½¿ç”¨ mdui çš„å¯¹è¯æ¡†
                const dialogContent = `
                    <div class="mdui-dialog" id="editMessageDialog">
                        <div class="mdui-dialog-title">ç¼–è¾‘æ¶ˆæ¯</div>
                        <div class="mdui-dialog-content">
                            <div class="mdui-textfield">
                                <textarea class="mdui-textfield-input" id="editMessageContent" rows="5">${msg.content}</textarea>
                            </div>
                        </div>
                        <div class="mdui-dialog-actions">
                            <button class="mdui-btn mdui-ripple" mdui-dialog-close>å–æ¶ˆ</button>
                            <button class="mdui-btn mdui-ripple" id="saveEditedMessage">ä¿å­˜</button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', dialogContent);
                const dialog = new mdui.Dialog('#editMessageDialog');
                dialog.open();

                document.getElementById('saveEditedMessage').addEventListener('click', () => {
                    const newContent = document.getElementById('editMessageContent').value;
                    msg.content = newContent;
                    saveChats();
                    updateMessageElement(msg);
                    dialog.close();
                    document.getElementById('editMessageDialog').remove();
                });

                dialog.$element.on('closed.mdui.dialog', function () {
                    document.getElementById('editMessageDialog').remove();
                });
            }
        }

        // å¤åˆ¶æ¶ˆæ¯
        function copyMessage(content) {
            navigator.clipboard.writeText(content).then(() => {
                mdui.snackbar({ message: 'æ¶ˆæ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿' });
            }).catch(err => {
                mdui.snackbar({ message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶' });
            });
        }

        // é‡æ–°ç”Ÿæˆæ¶ˆæ¯
        async function regenerateMessage(msgId) {
            const currentChat = getChatById(currentChatId);
            if (!currentChat) return;

            const index = currentChat.messages.findIndex(msg => msg.id === msgId);
            if (index === -1) return;

            // åˆ é™¤åŸæ¶ˆæ¯å¹¶æ¸²æŸ“
            currentChat.messages.splice(index, 1);
            saveChats();
            renderChat();

            // æ˜¾ç¤ºåŠ è½½ä¸­çš„æ¶ˆæ¯
            const loadingMsg = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                role: 'assistant',
                loading: true,
                content: ''
            };
            currentChat.messages.push(loadingMsg);
            saveChats();
            appendMessage(loadingMsg);

            // è°ƒç”¨ AI æ¥å£è·å–æ–°çš„å›å¤
            try {
                const response = await fetch(apiBaseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: selectedModel,
                        messages: currentChat.messages.filter(msg => !msg.loading),
                        functions: serverFunctions(),
                        function_call: "auto",
                        stream: true
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}ï¼Œé”™è¯¯ä¿¡æ¯ï¼š${errorText}`);
                }

                await handleStreamedResponse(response, loadingMsg);

            } catch (error) {
                const errorMsg = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    role: 'assistant',
                    content: `è¯·æ±‚å¤±è´¥: ${error.message}`
                };
                currentChat.messages.push(errorMsg);
                saveChats();
                appendMessage(errorMsg);
                console.error('è¯·æ±‚å¤±è´¥:', error);
            }
        }

        // ç®€å•çš„ Markdown è§£æ
        function parseMarkdown(text) {
        
            if (!text) return '';

            // é…ç½® marked.js
            marked.setOptions({
                breaks: true, // è‡ªåŠ¨å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>
                highlight: function (code, lang) {
                    // ä½¿ç”¨ highlight.js æ¸²æŸ“ä»£ç å—
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                },
            });

            // ä½¿ç”¨ marked.parse è§£æ Markdown
            return marked.parse(text);
        }

        // æ·»åŠ å¤åˆ¶æŒ‰é’®çš„åŠŸèƒ½


        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const content = userInput.value.trim();
            if (!content || !currentChatId) return;
            addMessage({ role: 'user', content });
            userInput.value = '';
            await getAIResponse();
        }

        // è‡ªåŠ¨ç”ŸæˆèŠå¤©æ ‡é¢˜
        function generateChatTitle() {
            const currentChat = getChatById(currentChatId);
            if (currentChat) {
                // å–æœ€æ–°çš„ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
                for (let i = currentChat.messages.length - 1; i >= 0; i--) {
                    if (currentChat.messages[i].role === 'user') {
                        currentChat.name = currentChat.messages[i].content.slice(0, 20);
                        break;
                    }
                }
                saveChats();
                renderChatList();
            }
        }

        // è·å– AI å›å¤
        async function getAIResponse() {
            const currentChat = getChatById(currentChatId);
            if (!currentChat) return;

            // æ˜¾ç¤ºåŠ è½½ä¸­çš„æ¶ˆæ¯
            const loadingMsg = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                role: 'assistant',
                loading: true,
                content: ''
            };
            currentChat.messages.push(loadingMsg);
            saveChats();
            appendMessage(loadingMsg);

            try {
                const functions = serverFunctions();

                const payload = {
                    model: selectedModel,
                    messages: currentChat.messages.filter(msg => !msg.loading),
                    functions: functions.length > 0 ? functions : undefined,
                    function_call: functions.length > 0 ? "auto" : { name: "none" },
                    stream: true
                };

                const response = await fetch(apiBaseUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`è¯·æ±‚å¤±è´¥ï¼š${response.status}ï¼Œé”™è¯¯ä¿¡æ¯ï¼š${errorText}`);
                }

                await handleStreamedResponse(response, loadingMsg);

            } catch (error) {
                const errorMsg = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    role: 'assistant',
                    content: `è¯·æ±‚å¤±è´¥: ${error.message}`
                };
                currentChat.messages.push(errorMsg);
                saveChats();
                appendMessage(errorMsg);
                console.error("è¯·æ±‚å¤±è´¥:", error);
            }
        }

        // å¤„ç†æµå¼å“åº”
        async function handleStreamedResponse(response, loadingMsg) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let done = false;
            let assistantMessage = '';
            let functionCall = null;
            let assistantMsg = loadingMsg;
            assistantMsg.content = '';
            // ä¸è¦åœ¨è¿™é‡Œå°† loading è®¾ç½®ä¸º false

            const currentChat = getChatById(currentChatId);
            if (!currentChat) return;

            while (!done) {
                const { value, done: readerDone } = await reader.read();
                done = readerDone;
                if (value) {
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') {
                                done = true;
                                break;
                            }
                            try {
                                const json = JSON.parse(dataStr);

                                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨é”™è¯¯
                                if (json.error) {
                                    throw new Error(json.error.message);
                                }

                                if (json.choices && json.choices[0]) {
                                    const delta = json.choices[0].delta;

                                    if (delta.content) {
                                        assistantMessage += delta.content;

                                        assistantMsg.content = assistantMessage;
                                        assistantMsg.loading = true; // ä¿æŒ loading ä¸º true
                                        saveChats();
                                        updateMessageElement(assistantMsg);
                                    } else if (delta.function_call) {
                                        // æ”¶é›†å‡½æ•°è°ƒç”¨ä¿¡æ¯
                                        if (!functionCall) {
                                            functionCall = {
                                                name: delta.function_call.name || '',
                                                arguments: delta.function_call.arguments || ''
                                            };
                                        } else {
                                            functionCall.arguments += delta.function_call.arguments || '';
                                        }

                                        // æ˜¾ç¤ºå‡½æ•°è°ƒç”¨æç¤º
                                        showFunctionCallTip(functionCall.name);
                                    }
                                } else {
                                    console.error('Unexpected JSON structure:', json);
                                }
                            } catch (e) {
                                console.error('è§£ææµæ•°æ®å‡ºé”™ï¼š', e);
                                // æ·»åŠ é”™è¯¯æ¶ˆæ¯
                                const errorMsg = {
                                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                                    role: 'assistant',
                                    content: `è¯·æ±‚å¤±è´¥: ${e.message}`
                                };
                                currentChat.messages.push(errorMsg);
                                saveChats();
                                appendMessage(errorMsg);
                                return;
                            }
                        }
                    }
                }
            }

            // å¦‚æœåŠ©æ‰‹æ¶ˆæ¯å†…å®¹ä¸ºç©ºä¸”å­˜åœ¨å‡½æ•°è°ƒç”¨ï¼Œç§»é™¤ç©ºç™½æ¶ˆæ¯
            if (assistantMessage.trim() === '' && functionCall) {
                // ä»èŠå¤©è®°å½•ä¸­ç§»é™¤åŠ©æ‰‹çš„ç©ºæ¶ˆæ¯
                const index = currentChat.messages.findIndex(msg => msg.id === assistantMsg.id);
                if (index !== -1) {
                    currentChat.messages.splice(index, 1);
                }
                // ä»ç•Œé¢ä¸­ç§»é™¤
                const messageDiv = document.getElementById(`message-${assistantMsg.id}`);
                if (messageDiv) {
                    messageDiv.remove();
                }
                saveChats();
            } else {
                // æµå¼å“åº”å¤„ç†å®Œæ¯•åï¼Œç§»é™¤å…‰æ ‡
                assistantMsg.loading = false;
                saveChats();
                updateMessageElement(assistantMsg);
            }

            // å¦‚æœå­˜åœ¨å‡½æ•°è°ƒç”¨ï¼Œå¤„ç†å‡½æ•°è°ƒç”¨
            if (functionCall) {
                try {
                    showFunctionCallTip(functionCall.name);
                    const funcResponse = await handleFunctionCall(functionCall);
                    
                    // æ·»åŠ å‡½æ•°è°ƒç”¨ç»“æœåˆ°èŠå¤©è®°å½•
                    currentChat.messages.push(funcResponse);
                    
                    saveChats();
                    appendMessage(funcResponse);

                    // éšè—å‡½æ•°è°ƒç”¨æç¤º
                    // å»¶è¿Ÿ 2 ç§’åæ‰§è¡Œ hideFunctionCallTip()
setTimeout(() => {
    hideFunctionCallTip();
}, 2000);


                    // ç»§ç»­è¯·æ±‚ AI å›å¤
                    await getAIResponse();
                } catch (error) {
                    console.error('å‡½æ•°è°ƒç”¨å‡ºé”™ï¼š', error);
                    const errorMsg = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        role: 'assistant',
                        content: `å‡½æ•°è°ƒç”¨å¤±è´¥: ${error.message}`
                    };
                    currentChat.messages.push(errorMsg);
                    saveChats();
                    appendMessage(errorMsg);
                    // éšè—å‡½æ•°è°ƒç”¨æç¤º
                    // å»¶è¿Ÿ 2 ç§’åæ‰§è¡Œ hideFunctionCallTip()
setTimeout(() => {
    hideFunctionCallTip();
}, 2000);

                }
            }
        }

        // æ˜¾ç¤ºå³é”®èœå•
        function showContextMenu(x, y) {
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            contextMenu.style.display = 'block';
        }

        // éšè—å³é”®èœå•
        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }

        // å¤åˆ¶æ¶ˆæ¯ï¼ˆç”¨äºå³é”®èœå•ï¼‰
        function copyClickedMessage() {
            navigator.clipboard.writeText(clickedMessageContent).then(() => {
                mdui.snackbar({ message: 'æ¶ˆæ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿' });
            }).catch(err => {
                mdui.snackbar({ message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶' });
            });
            hideContextMenu();
        }

        // ç‚¹å‡»å¤åˆ¶æ¶ˆæ¯èœå•é¡¹
        copyMessageItem.addEventListener('click', copyClickedMessage);

        // å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼Œéšè—å³é”®èœå•
        document.addEventListener('click', function (e) {
            if (contextMenu.style.display === 'block') {
                hideContextMenu();
            }
        });

        // æ˜¾ç¤ºå‡½æ•°è°ƒç”¨æç¤ºæ¡†
        function showFunctionCallTip(functionName) {
            functionCallTip.textContent = `GPTæ­£åœ¨è°ƒç”¨${functionName}æ“ä½œ`;
            functionCallTip.style.display = 'block';
        }

        // éšè—å‡½æ•°è°ƒç”¨æç¤ºæ¡†
        function hideFunctionCallTip() {
            functionCallTip.style.display = 'none';
        }

        // å®šä¹‰æœåŠ¡å™¨ç®¡ç†çš„å‡½æ•°
        function serverFunctions() {
    return [
        {
            name: "getGptStatus",
            description: "è·å–ChatGPTçŠ¶æ€",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        },
        {
            name: "restartServer",
            description: "é‡å¯æœåŠ¡å™¨",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        },
        {
            name: "searchWeb",
            description: "åœ¨ç½‘ç»œä¸Šæœç´¢ä¿¡æ¯",
            parameters: {
                type: "object",
                properties: {
                    query: { type: "string", description: "è¦æœç´¢çš„å…³é”®è¯" }
                },
                required: ["query"]
            }
        },
        // æ–°å¢çš„æœåŠ¡å™¨æ§åˆ¶åŠŸèƒ½
        {
            name: "startHost",
            description: "å¯åŠ¨ä¸»æœº",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        },
        {
            name: "closeHost",
            description: "å…³é—­ä¸»æœº",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        },
        {
            name: "powerHost",
            description: "æ–­ç”µä¸»æœº",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        },
        {
            name: "createSnapshot",
            description: "åˆ›å»ºä¸»æœºå¿«ç…§",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        },
        {
            name: "createBackup",
            description: "åˆ›å»ºä¸»æœºå¤‡ä»½",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        },
        {
            name: "addFirewall",
            description: "æ·»åŠ é˜²ç«å¢™ç­–ç•¥",
            parameters: {
                type: "object",
                properties: {
                    policy: { type: "string", description: "é˜²ç«å¢™ç­–ç•¥å†…å®¹" }
                },
                required: ["policy"]
            }
        },
        {
            name: "link",
            description: "å»ºç«‹æ™®é€šè¿æ¥",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        },
        {
            name: "vnc",
            description: "è·å–VNCè¿æ¥",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        },
        {
            name: "lowvnc",
            description: "è·å–ä½å¸¦å®½VNCè¿æ¥",
            parameters: {
                type: "object",
                properties: {},
                required: []
            }
        }
    ];
}



        // å¤„ç†å‡½æ•°è°ƒç”¨
        async function handleFunctionCall(function_call) {
    const { name, arguments: args } = function_call;
   
    if (!name) {
        console.error("Function call is missing 'name':", function_call);
        return { role: "function", name: "unknown", content: "æœªå®šä¹‰çš„å‡½æ•°è°ƒç”¨" };
    }

    let result = "";
    try {
        switch (name) {
            case "getGptStatus":
                // å…·ä½“é€»è¾‘
                result = "1";
                break;
            case "restartServer":
                // å…·ä½“é€»è¾‘
                result = "æœåŠ¡å™¨æ­£åœ¨é‡å¯...";
                await new Promise(resolve => setTimeout(resolve, 2000)); // æ¨¡æ‹Ÿé‡å¯è¿‡ç¨‹
                result = "æœåŠ¡å™¨å·²æˆåŠŸé‡å¯ã€‚";
                break;
            case "searchWeb":
                let query = "";
                try {
                    query = JSON.parse(args || "{}").query || "æœªçŸ¥å…³é”®è¯";
                } catch (e) {
                    console.error("è§£æå‡½æ•°å‚æ•°é”™è¯¯ï¼š", e);
                    query = "æœªçŸ¥å…³é”®è¯";
                }

                // ç®€å•æœç´¢é€»è¾‘ï¼Œå¯ä»¥é›†æˆå®é™…çš„æœç´¢API
                result = `æœç´¢ç»“æœï¼šå…³äº "${query}" çš„æœ€æ–°ä¿¡æ¯ã€‚`;
                break;
            
            // æ–°å¢çš„æœåŠ¡å™¨æ§åˆ¶åŠŸèƒ½
            case "startHost":
                result = await startHost();
                break;
            case "closeHost":
                result = await closeHost();
                break;
            case "powerHost":
                result = await powerHost();
                break;
            case "createSnapshot":
                result = await createSnapshot();
                break;
            case "createBackup":
                result = await createBackup();
                break;
            case "addFirewall":
                let policy = "";
                try {
                    policy = JSON.parse(args || "{}").policy || "é»˜è®¤ç­–ç•¥";
                } catch (e) {
                    console.error("è§£æå‡½æ•°å‚æ•°é”™è¯¯ï¼š", e);
                    policy = "é»˜è®¤ç­–ç•¥";
                }
                result = await addFirewall(policy);
                break;
            case "link":
                result = await link();
                break;
            case "vnc":
                result = await vnc();
                break;
            case "lowvnc":
                result = await lowvnc();
                break;
            default:
                result = `æœªçŸ¥å‡½æ•°: ${name}`;
        }
    } catch (error) {
        console.error("Function execution error:", error);
        result = `å‡½æ•°æ‰§è¡Œå¤±è´¥: ${error.message}`;
    }
    
    return {
        role: "function",
        name,
        content: result
    };
}
        // å¯¼å‡ºèŠå¤©è®°å½•
        function exportChat() {
            if (!currentChatId) {
                mdui.snackbar({ message: 'è¯·é€‰æ‹©ä¸€ä¸ªèŠå¤©ä¼šè¯è¿›è¡Œå¯¼å‡º' });
                return;
            }
            const currentChat = getChatById(currentChatId);
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentChat, null, 2));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", `${currentChat.name}_chat_history.json`);
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            downloadAnchor.remove();
        }

        // å¯¼å…¥èŠå¤©è®°å½•
        function importChat(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedChat = JSON.parse(e.target.result);
                    if (importedChat.id && importedChat.name && Array.isArray(importedChat.messages)) {
                        chats.push(importedChat);
                        currentChatId = importedChat.id;
                        saveChats();
                        renderChatList();
                        renderChat();
                        mdui.snackbar({ message: 'èŠå¤©è®°å½•å¯¼å…¥æˆåŠŸ' });
                    } else {
                        throw new Error("æ— æ•ˆçš„èŠå¤©è®°å½•æ ¼å¼");
                    }
                } catch (error) {
                    mdui.snackbar({ message: `å¯¼å…¥å¤±è´¥: ${error.message}` });
                }
            };
            reader.readAsText(file);
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯ HTML ä»£ç 
        function isHtmlCode(code) {
            return /<\/?[a-z][\s\S]*>/i.test(code);
        }

        // æ˜¾ç¤º HTML é¢„è§ˆ
        function showHtmlPreview(htmlContent) {
            const dialogHtml = `
                <div class="mdui-dialog" id="htmlPreviewDialog">
                    <div class="mdui-dialog-title">HTML é¢„è§ˆ</div>
                    <div class="mdui-dialog-content">
                        <iframe id="htmlPreviewFrame" style="width:100%; height:400px; border:none;"></iframe>
                    </div>
                    <div class="mdui-dialog-actions">
                        <button class="mdui-btn mdui-ripple" mdui-dialog-close>å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', dialogHtml);
            const dialog = new mdui.Dialog('#htmlPreviewDialog');
            dialog.open();

            // å°† HTML å†…å®¹å†™å…¥ iframe
            const iframe = document.getElementById('htmlPreviewFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(htmlContent);
            iframeDoc.close();

            // ç›‘å¬å¯¹è¯æ¡†å…³é—­äº‹ä»¶ï¼Œç§»é™¤å¯¹è¯æ¡†å…ƒç´ 
            dialog.$element.on('closed.mdui.dialog', function () {
                dialog.$element.remove();
            });
        }

        // è¯­éŸ³è¾“å…¥å’Œè¾“å‡º
        let recognizing = false;
        let recognition;
        let synth = window.speechSynthesis;

        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                mdui.snackbar({ message: 'æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«' });
                return;
            }
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value += transcript;
            };

            recognition.onerror = (event) => {
                mdui.snackbar({ message: `è¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}` });
            };
        }

        function speak(text) {
            if (!synth) return;
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = 'zh-CN';
            synth.speak(utterThis);
        }

        // äº‹ä»¶ç»‘å®š
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        voiceBtn.addEventListener('click', () => {
            if (!recognition) {
                initSpeechRecognition();
            }
            if (recognizing) {
                recognition.stop();
                recognizing = false;
                voiceBtn.innerHTML = '<i class="mdui-icon material-icons">mic</i>';
            } else {
                recognition.start();
                recognizing = true;
                voiceBtn.innerHTML = '<i class="mdui-icon material-icons">mic_off</i>';
            }
        });

        // æ–‡ä»¶ä¸Šä¼ 
        fileUploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            const files = fileInput.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    // å¤„ç†æ–‡ä»¶ï¼Œè¿™é‡Œä»…æ˜¾ç¤ºæ–‡ä»¶å
                    addMessage({ role: 'user', content: `å·²ä¸Šä¼ æ–‡ä»¶ï¼š${file.name}` });
                }
                fileInput.value = '';
            }
        });

        exportBtn.addEventListener('click', exportChat);

        importBtn.addEventListener('click', () => {
            importFile.click();
        });

        importFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                importChat(e.target.files[0]);
                importFile.value = '';
            }
        });

        addChatBtn.addEventListener('click', () => {
            const chatName = prompt('è¯·è¾“å…¥æ–°çš„èŠå¤©ä¼šè¯åç§°', 'æ–°èŠå¤©');
            if (chatName) {
                addNewChat(chatName);
            }
        });

        // æ¨¡å‹é€‰æ‹©å™¨
        modelSelector.value = selectedModel;
        modelSelector.addEventListener('change', () => {
            selectedModel = modelSelector.value;
            localStorage.setItem('selectedModel', selectedModel);
        });

        // è¿”å›åº•éƒ¨æŒ‰é’®
        scrollToBottomBtn.addEventListener('click', () => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        chatMessages.addEventListener('scroll', () => {
            if (chatMessages.scrollHeight - chatMessages.scrollTop > chatMessages.clientHeight + 100) {
                scrollToBottomBtn.style.display = 'block';
            } else {
                scrollToBottomBtn.style.display = 'none';
            }
        });

        // é…ç½®å¯¹è¯æ¡†
        const configDialog = new mdui.Dialog('#configDialog', {
            modal: true,
            history: false
        });

        // é…ç½®æŒ‰é’®äº‹ä»¶
        const configBtn = document.getElementById('configBtn');
        configBtn.addEventListener('click', () => {
            document.getElementById('apiBaseUrl').value = apiBaseUrl;
            document.getElementById('apiKey').value = apiKey;
            configDialog.open();
        });

        // ä¿å­˜é…ç½®
        document.getElementById('saveConfig').addEventListener('click', () => {
            apiBaseUrl = document.getElementById('apiBaseUrl').value.trim();
            apiKey = document.getElementById('apiKey').value.trim();
            localStorage.setItem('apiBaseUrl', apiBaseUrl);
            localStorage.setItem('apiKey', apiKey);
            configDialog.close();
            mdui.snackbar({ message: 'é…ç½®å·²ä¿å­˜' });
        });

        // åˆå§‹åŒ–
        function initialize() {
            if (chats.length === 0) {
                addNewChat('æ–°èŠå¤©');
            } else if (!currentChatId) {
                currentChatId = chats[0].id;
                saveChats();
            }
            renderChatList();
            renderChat();
        }

        initialize();


    </script>
    <script>
        // é…ç½® marked.js
        marked.setOptions({
            breaks: true, // è‡ªåŠ¨å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>
            highlight: function (code, lang) {
                // ä½¿ç”¨ highlight.js æ¸²æŸ“ä»£ç å—
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            }
        });
        function updateChatHeight() {
    const toolbar = document.querySelector('.mdui-toolbar');
    const toolbarHeight = toolbar ? toolbar.offsetHeight : 0;

    // è®¾ç½® CSS å˜é‡
    document.documentElement.style.setProperty('--toolbar-height', `${toolbarHeight}px`);
}

// åœ¨é¡µé¢åŠ è½½å’Œçª—å£è°ƒæ•´å¤§å°æ—¶æ›´æ–°é«˜åº¦
window.addEventListener('load', updateChatHeight);
window.addEventListener('resize', updateChatHeight);
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages'); // æ›¿æ¢ä¸ºä½ çš„èŠå¤©æ¶ˆæ¯å®¹å™¨ ID
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
});
async function startHost() {
    const url = `${rootUrl}start_host`;
    const data = JSON.stringify({ hostid });
    try {
        const response = await postRequest(url, data);
        if (response.code === 1) {
            return response.msg;
        } else {
            return `å¯åŠ¨ä¸»æœºå¤±è´¥:${response.message}`;
        }
    } catch (error) {
        console.error("startHost error:", error);
        return `å¯åŠ¨ä¸»æœºå¤±è´¥: ${error.message}`;
    }
}

async function closeHost() {
    const url = `${rootUrl}close_host`;
    const data = JSON.stringify({ hostid });
    try {
        const response = await postRequest(url, data);
        if (response.code === 1) {
            return response.msg;
        } else {
            return `å…³é—­ä¸»æœºå¤±è´¥: ${response.msg}`;
        }
    } catch (error) {
        console.error("closeHost error:", error);
        return `å…³é—­ä¸»æœºå¤±è´¥: ${error.message}`;
    }
}

async function powerHost() {
    const url = `${rootUrl}power_host`;
    const data = JSON.stringify({ hostid });
    try {
        const response = await postRequest(url, data);
        if (response.code === 1) {
            return response.msg;
        } else {
            return `æ–­ç”µä¸»æœºå¤±è´¥: ${response.msg}`;
        }
    } catch (error) {
        console.error("powerHost error:", error);
        return `æ–­ç”µä¸»æœºå¤±è´¥: ${error.message}`;
    }
}

async function createSnapshot() {
    const url = `${rootUrl}create_snapshot_host`;
    const data = JSON.stringify({ hostid });
    try {
        const response = await postRequest(url, data);
        if (response.code === 1) {
            // å‡è®¾ insTbSp æ˜¯å…¨å±€å¯è®¿é—®çš„è¡¨æ ¼å®ä¾‹
            if (typeof insTbSp !== 'undefined' && insTbSp.reload) {
                insTbSp.reload();
                setTimeout(() => insTbSp.reload(), 30000);
            }
            return response.msg;
        } else {
            return `åˆ›å»ºå¿«ç…§å¤±è´¥: ${response.msg}`;
        }
    } catch (error) {
        console.error("createSnapshot error:", error);
        return `åˆ›å»ºå¿«ç…§å¤±è´¥: ${error.message}`;
    }
}

async function createBackup() {
    const url = `${rootUrl}create_backup_host`;
    const data = JSON.stringify({ hostid });
    try {
        const response = await postRequest(url, data);
        if (response.code === 1) {
            // å‡è®¾ insTbBp æ˜¯å…¨å±€å¯è®¿é—®çš„è¡¨æ ¼å®ä¾‹
            if (typeof insTbBp !== 'undefined' && insTbBp.reload) {
                insTbBp.reload();
                setTimeout(() => insTbBp.reload(), 30000);
            }
            return response.msg;
        } else {
            return `åˆ›å»ºå¤‡ä»½å¤±è´¥: ${response.msg}`;
        }
    } catch (error) {
        console.error("createBackup error:", error);
        return `åˆ›å»ºå¤‡ä»½å¤±è´¥: ${error.message}`;
    }
}

async function addFirewall(policy) {
    const url = `${rootUrl}add_firewall_host`;
    const data = JSON.stringify({ hostid, policy });
    try {
        const response = await postRequest(url, data);
        if (response.code === 1) {
            // å‡è®¾ firewallinsTb æ˜¯å…¨å±€å¯è®¿é—®çš„è¡¨æ ¼å®ä¾‹
            if (typeof firewallinsTb !== 'undefined' && firewallinsTb.reload) {
                firewallinsTb.reload();
            }
            return response.msg;
        } else {
            return `æ·»åŠ é˜²ç«å¢™ç­–ç•¥å¤±è´¥: ${response.msg}`;
        }
    } catch (error) {
        console.error("addFirewall error:", error);
        return `æ·»åŠ é˜²ç«å¢™ç­–ç•¥å¤±è´¥: ${error.message}`;
    }
}

// 5. è¿æ¥ç›¸å…³åŠŸèƒ½
async function getCidAndRedirect(url) {
    const data = JSON.stringify({ hostid });
    try {
        const response = await postRequest(url, data);
        if (response.code === 200) {
            const cid = response.data;
            const redirectUrl = `https://netmc.icu:8099/Myrtille/?__EVENTTARGET=&__EVENTARGUMENT=&cid=${cid}&connect=Connect%21`;
            // ç”±äºè¿™æ˜¯åç«¯ä»£ç ï¼Œæ— æ³•ç›´æ¥åœ¨å‰ç«¯æ‰“å¼€æ–°æ ‡ç­¾é¡µã€‚
            // å¯ä»¥å°†é‡å®šå‘URLè¿”å›ç»™å‰ç«¯ï¼Œç”±å‰ç«¯è¿›è¡Œè·³è½¬ã€‚
            return `è¯·åœ¨æµè§ˆå™¨ä¸­è®¿é—®: ${redirectUrl}`;
        } else {
            return `è¯·æ±‚å¤±è´¥: ${response.msg}`;
        }
    } catch (error) {
        console.error("getCidAndRedirect error:", error);
        return `å‘ç”Ÿé”™è¯¯: ${error.message}`;
    }
}

async function link() {
    const url = `${rootUrl}CreateNormalConnect`;
    return await getCidAndRedirect(url);
}

async function vnc() {
    const url = `${rootUrl}getVNC`;
    return await getCidAndRedirect(url);
}

async function lowvnc() {
    const url = `${rootUrl}getVNC?IsEnhancedMode=false`;
    return await getCidAndRedirect(url);
}

// 6. æ·»åŠ ç®€å•çš„æœç´¢åŠŸèƒ½
async function performSearch(query) {
    const function_call = {
        name: "searchWeb",
        arguments: JSON.stringify({ query })
    };
    const response = await handleFunctionCall(function_call);
    console.log(response.content);
    // æ ¹æ®éœ€è¦ï¼Œå¯ä»¥è¿›ä¸€æ­¥å¤„ç†æœç´¢ç»“æœï¼Œä¾‹å¦‚è¿”å›ç»™å‰ç«¯
}

// ç¤ºä¾‹è°ƒç”¨
(async () => {
    // ä¾‹å¦‚ï¼Œå¯åŠ¨ä¸»æœº
    const startResponse = await handleFunctionCall({
        name: "startHost",
        arguments: "{}"
    });
    console.log(startResponse.content);

    // åˆ›å»ºå¿«ç…§
    const snapshotResponse = await handleFunctionCall({
        name: "createSnapshot",
        arguments: "{}"
    });
    console.log(snapshotResponse.content);

    // æ‰§è¡Œæœç´¢
    await performSearch("ChatGPT åŠŸèƒ½");
})();
    </script>
   

<script>
    // å®šä¹‰å­é¡µé¢çš„å…¨å±€å˜é‡
    var rootUrl = window.parent.rootUrlw ;
    var hostid = window.parent.hostId ;
    var   $ = window.parent.layui.jquery;
    function postRequest(url, data) {
    return $.ajax({
        url: url,                  // è¯·æ±‚çš„ URL
        type: 'POST',              // è¯·æ±‚æ–¹æ³•ä¸º POST
        data: data,// å°†æ•°æ®åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²
        contentType: 'application/json', // è®¾ç½®è¯·æ±‚å¤´ä¸º JSON
        dataType: 'json'           // æœŸæœ›æœåŠ¡å™¨è¿”å› JSON æ•°æ®
    });
}

   
</script>
</body>

</html>